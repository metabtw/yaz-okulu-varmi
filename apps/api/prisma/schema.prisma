// ============================================================
// Yaz Okulu Var mı? - Prisma Veritabanı Şeması
// Tüm veritabanı modelleri, ilişkileri ve index tanımları.
// Multitenancy: Her üniversite sadece kendi verisine erişebilir.
// ============================================================

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ---- Enum Tanımları ----

/// Kullanıcı rolleri
enum Role {
  STUDENT
  UNIVERSITY
  ADMIN
}

/// Kullanıcı hesap durumları
enum UserStatus {
  PENDING   // Onay bekliyor (Üniversite yetkilisi ilk kayıt)
  APPROVED  // Admin tarafından onaylandı
  REJECTED  // Admin tarafından reddedildi
  ACTIVE    // Aktif kullanıcı
}

// ---- Modeller ----

/// Üniversite modeli - SaaS kiracı (tenant) birimi
model University {
  id           String   @id @default(cuid())
  name         String   @unique // Üniversite adı benzersiz olmalı
  slug         String   @unique // URL dostu isim (örn: istanbul-teknik-universitesi)
  city         String              // Şehir bilgisi (Filtreleme için)
  logo         String?             // Logo URL'si
  website      String?             // Üniversite web sitesi
  contactEmail String?             // İletişim e-postası
  isVerified   Boolean  @default(false) // Admin tarafından onay durumu

  // Widget konfigürasyonu - PostgreSQL native JSON desteği
  widgetConfig Json?    @default("{\"primaryColor\": \"#1e40af\", \"theme\": \"light\"}")

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // İlişkiler
  users        User[]   // Bu üniversiteye bağlı yetkili kullanıcılar
  courses      Course[] // Üniversitenin açtığı yaz okulu dersleri

  @@index([city])        // Şehir bazlı filtreleme performansı
  @@index([isVerified])  // Onaylı üniversite sorguları
}

/// Kullanıcı modeli - Tüm roller için tek tablo
model User {
  id           String      @id @default(cuid())
  email        String      @unique
  passwordHash String               // bcrypt ile hashlenmiş şifre
  fullName     String?               // Tam ad
  role         Role        @default(STUDENT)
  status       UserStatus  @default(ACTIVE)
  department   String?               // Bölüm (öğrenci için)
  preferredCities Json?               // Tercih edilen şehirler (öğrenci için)

  // Multitenancy bağlantısı: UNIVERSITY rolü için zorunlu
  universityId String?
  university   University? @relation(fields: [universityId], references: [id])

  // Öğrenci ilişkileri
  favorites    UserFavorite[]
  interactions UserInteraction[]

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([role])          // Rol bazlı sorgulama
  @@index([status])        // Durum bazlı sorgulama (Pending onay listesi)
  @@index([universityId])  // Üniversite bazlı kullanıcı listeleme
}

/// Ders modeli - Yaz okulu ders bilgileri
model Course {
  id             String     @id @default(cuid())
  code           String               // Ders kodu (örn: MAT101)
  name           String               // Ders adı (örn: Matematik I)
  ects           Int                  // AKTS kredisi
  price          Decimal?   @db.Decimal(10, 2) // Ücret (PostgreSQL Decimal)
  currency       String     @default("TRY")
  isOnline       Boolean    @default(false) // Uzaktan eğitim seçeneği
  description    String?              // Ders açıklaması
  applicationUrl String?              // Başvuru/kayıt linki
  quota          Int?                 // Kontenjan bilgisi
  startDate      DateTime?            // Ders başlangıç tarihi
  endDate        DateTime?            // Ders bitiş tarihi

  // İlişki - Hangi üniversiteye ait
  universityId   String
  university     University @relation(fields: [universityId], references: [id], onDelete: Cascade)

  viewCount     Int        @default(0) // Popülerlik için görüntülenme sayısı

  // Öğrenci ilişkileri
  favoritedBy     UserFavorite[]
  interactions    UserInteraction[]

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Performans index'leri - Sık yapılan sorguları hızlandırır
  @@index([name])                    // İsimle arama
  @@index([code])                    // Kodla arama
  @@index([universityId])            // Üniversite bazlı listeleme
  @@index([isOnline])                // Online filtresi
  @@index([name, code, universityId]) // Bileşik index - Genel arama sorgusu
}

/// Arama logu - Akademik makale için istatistiksel veri toplama
model SearchLog {
  id          String   @id @default(cuid())
  searchQuery String?            // Kullanıcının yazdığı arama metni
  filters     Json?              // Uygulanan filtreler (PostgreSQL native JSON)
  resultCount Int                // Kaç sonuç döndüğü
  ipHash      String?            // Anonimleştirilmiş IP (SHA-256 hash)
  userAgent   String?            // Tarayıcı bilgisi (mobil/desktop analizi)
  userId      String?            // Giriş yapmış öğrenci (opsiyonel)
  createdAt   DateTime @default(now())

  @@index([createdAt])           // Tarih bazlı raporlama
  @@index([searchQuery])         // Popüler arama analizi
  @@index([userId])              // Öğrenci arama geçmişi
}

/// Aktivite logu - Güvenlik denetimi ve değişiklik takibi (Audit Trail)
model ActivityLog {
  id        String   @id @default(cuid())
  userId    String             // İşlemi yapan kullanıcı ID'si
  action    String             // İşlem tipi: COURSE_CREATE, COURSE_UPDATE, UNIVERSITY_VERIFY vb.
  entity    String?            // Etkilenen varlık tipi: Course, University
  entityId  String?            // Etkilenen varlık ID'si
  details   Json?              // Değişiklik detayları (PostgreSQL native JSON)
  ipAddress String?            // İşlem yapılan IP
  createdAt DateTime @default(now())

  @@index([userId])            // Kullanıcı bazlı aktivite geçmişi
  @@index([action])            // İşlem tipi bazlı filtreleme
  @@index([createdAt])         // Zaman bazlı sorgulama
}

/// Öğrenci favori dersleri
model UserFavorite {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

/// Öğrenci ders etkileşimleri (görüntüleme, başvuru vb.)
model UserInteraction {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId   String
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  actionType String   // VIEW, FAVORITE, APPLY
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([userId, actionType])
}
